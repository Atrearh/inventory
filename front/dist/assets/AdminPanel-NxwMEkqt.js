import{r as o,br as S,bo as a}from"./vendor-BO8aFb6R.js";import{u as L,k as O,l as V,m as B}from"./index-ousJY6BN.js";import{b as $}from"./useApiQueries-C_dxe9Bt.js";import{u as g}from"./useApiMutation-UX_6QUDT.js";import{a as R}from"./vendor_tanstack-Croh7sPd.js";import{c as W,v as Y,s as G,u as H,d as J,g as N}from"./domain.api-C7nlQmbT.js";import{F as i,s as C,a as A,B as l,P as q,C as P,f as K,m as T,I as u}from"./vendor_antd-DBq17MzT.js";function z({form:e,defaultValues:r}){const[x,_]=o.useState(!1),[d,n]=o.useState(null),b=o.useCallback(()=>{n(null),e.resetFields(),r&&e.setFieldsValue(r),_(!0)},[e,r]),c=o.useCallback(y=>{n(y),e.setFieldsValue(y),_(!0)},[e]),p=o.useCallback(()=>{_(!1),n(null),e.resetFields()},[e]);return{isModalOpen:x,editingItem:d,openCreateModal:b,openEditModal:c,handleCancel:p}}const X=()=>{const{t:e}=S(),[r]=i.useForm(),[x,_]=o.useState(!1),{isModalOpen:d,editingItem:n,openCreateModal:b,openEditModal:c,handleCancel:p}=z({form:r,defaultValues:{server_url:"server.com",ad_base_dn:"DC=example,DC=com"}}),{data:y=[],isLoading:j}=R({queryKey:["domains"],queryFn:N,enabled:!0,staleTime:3600*1e3,gcTime:3600*1e3,refetchOnWindowFocus:!1}),{mutate:w,isPending:f}=g({mutationFn:s=>W(s),successMessage:e("domain_created"),invalidateQueryKeys:[["domains"]],onSuccessCallback:()=>p()}),{mutate:M,isPending:I}=g({mutationFn:s=>Y(s),successMessage:e("connection_validated",{message:"{message}"}),onSuccessCallback:s=>{C.success(e("connection_validated",{message:s.message}))}}),{mutate:k,isPending:v}=g({mutationFn:s=>G(s),onSuccessCallback:s=>{s.task_id?C.success(e("domain_scan_started",{task_id:s.task_id})):s.task_ids&&C.success(e("scan_all_domains_started",{task_ids:s.task_ids.join(", ")}))},errorMessage:e("domain_scan_error")}),{mutate:F,isPending:m}=g({mutationFn:({id:s,data:t})=>H(s,t),successMessage:e("domain_updated"),invalidateQueryKeys:[["domains"]],onSuccessCallback:()=>p()}),{mutate:h,isPending:D}=g({mutationFn:s=>J(s),successMessage:e("domain_deleted"),invalidateQueryKeys:[["domains"]]}),Q=async()=>{try{_(!0);const s=await r.validateFields(),t={name:s.name,username:s.username,password:s.password,server_url:s.server_url,ad_base_dn:s.ad_base_dn};M(t)}catch(s){C.error(s.message||e("error"))}finally{_(!1)}},U=async()=>{try{const s=await r.validateFields(),t={id:n?n.id:0,name:s.name,username:s.username,password:s.password,server_url:s.server_url,ad_base_dn:s.ad_base_dn,last_updated:null};if(n)F({id:n.id,data:t});else{const{id:ee,last_updated:ae,...E}=t;w(E)}}catch(s){C.error(s.message||e("error"))}},Z=o.useMemo(()=>[{title:e("domain"),dataIndex:"name",key:"name",sorter:(s,t)=>s.name.localeCompare(t.name)},{title:e("username"),dataIndex:"username",key:"username",sorter:(s,t)=>s.username.localeCompare(t.username)},{title:e("server_url"),dataIndex:"server_url",key:"server_url"},{title:e("ad_base_dn"),dataIndex:"ad_base_dn",key:"ad_base_dn"},{title:e("last_updated"),dataIndex:"last_updated",key:"last_updated"},{title:e("actions"),key:"actions",render:(s,t)=>a.jsxs(A,{children:[a.jsx(l,{onClick:()=>c(t),"aria-label":e("edit_domain",{name:t.name}),children:e("edit")}),a.jsx(l,{onClick:()=>k(t.id),loading:v,disabled:v,"aria-label":`${e("scan_domain")} ${t.name}`,children:e("scan_domain")}),a.jsx(q,{title:e("confirm_delete_domain"),onConfirm:()=>h(t.id),okText:e("yes"),cancelText:e("no"),children:a.jsx(l,{danger:!0,loading:D,"aria-label":e("delete_domain",{name:t.name}),children:e("delete")})})]})}],[D,v,h,c,k,e]);return a.jsxs(P,{title:e("domain_management"),style:{marginBottom:24},extra:a.jsx(l,{type:"primary",onClick:b,"aria-label":e("add_domain"),children:e("add_domain")}),children:[a.jsx(K,{dataSource:y,columns:Z,rowKey:"id",loading:j,pagination:!1,"aria-label":e("domains_table")}),a.jsx(T,{title:e(n?"edit_domain_title":"new_domain"),open:d,onCancel:p,footer:[a.jsx(l,{onClick:p,"aria-label":e("cancel"),children:e("cancel")},"back"),a.jsx(l,{loading:I,onClick:Q,"aria-label":e("validate_connection"),children:e("validate_connection")},"validate"),a.jsx(l,{type:"primary",loading:f||m,onClick:()=>r.submit(),"aria-label":e(n?"save_domain_changes":"create_domain"),children:e(n?"save":"create")},"submit")],children:a.jsxs(i,{form:r,layout:"vertical",onFinish:U,children:[a.jsx(i.Item,{name:"name",label:e("domain"),rules:[{required:!0,message:e("enter_domain")},{whitespace:!0,message:e("no_whitespace")},{pattern:/^[a-zA-Z0-9][a-zA-Z0-9\-]*(\.[a-zA-Z0-9][a-zA-Z0-9\-]*)+$/,message:e("invalid_domain_format")}],children:a.jsx(u,{placeholder:e("domain_placeholder")})}),a.jsx(i.Item,{name:"username",label:e("username"),rules:[{required:!0,message:e("enter_username")},{whitespace:!0,message:e("no_whitespace")}],tooltip:n?e("username_format_tip"):void 0,children:a.jsx(u,{placeholder:e("username_placeholder")})}),a.jsx(i.Item,{name:"password",label:e(n?"new_password":"password"),rules:n?[{whitespace:!0,message:e("no_whitespace")}]:[{required:!0,message:e("enter_password")},{whitespace:!0,message:e("no_whitespace")}],tooltip:n?e("password_change_tip"):void 0,children:a.jsx(u.Password,{placeholder:e("password_placeholder")})}),a.jsx(i.Item,{name:"server_url",label:e("server_url"),rules:[{required:!0,message:e("enter_server_url")},{whitespace:!0,message:e("no_whitespace")},{pattern:/^[a-zA-Z0-9][a-zA-Z0-9\-]*(\.[a-zA-Z0-9][a-zA-Z0-9\-]*)+$/,message:e("invalid_server_url_format")}],children:a.jsx(u,{placeholder:e("server_url_placeholder")})}),a.jsx(i.Item,{name:"ad_base_dn",label:e("ad_base_dn"),rules:[{required:!0,message:e("enter_ad_base_dn")},{whitespace:!0,message:e("no_whitespace")}],children:a.jsx(u,{placeholder:e("ad_base_dn_placeholder")})})]})})]})},oe=()=>{const{t:e}=S(),{setPageTitle:r}=L(),[x]=i.useForm(),{isModalOpen:_,editingItem:d,openCreateModal:n,openEditModal:b,handleCancel:c}=z({form:x}),{data:p,isLoading:y}=$(),j=["users"];o.useEffect(()=>{r(e("admin_panel_title"))},[e,r]);const{mutate:w,isPending:f}=g({mutationFn:O,successMessage:e("register_success"),errorMessage:e("register_error"),invalidateQueryKeys:[j],onSuccessCallback:c}),{mutate:M,isPending:I}=g({mutationFn:({id:m,data:h})=>V(m,h),successMessage:e("user_updated"),errorMessage:e("update_error"),invalidateQueryKeys:[j],onSuccessCallback:c}),{mutate:k}=g({mutationFn:B,successMessage:e("user_deleted"),errorMessage:e("delete_error"),invalidateQueryKeys:[j]}),v=o.useMemo(()=>[{title:e("username"),dataIndex:"username",key:"username"},{title:e("email"),dataIndex:"email",key:"email"},{title:e("role"),dataIndex:"role",key:"role",render:m=>m||"-"},{title:e("actions"),key:"actions",render:(m,h)=>a.jsxs(A,{size:"middle",children:[a.jsx(l,{type:"link",onClick:()=>b(h),"aria-label":e("edit"),children:e("edit")}),a.jsx(q,{title:e("confirm_delete"),onConfirm:()=>k(h.id),okText:e("yes","Yes"),cancelText:e("cancel"),children:a.jsx(l,{type:"link",danger:!0,"aria-label":e("delete_user"),children:e("delete")})})]})}],[e,b,k]),F=o.useCallback(m=>{d?M({id:d.id,data:m}):w(m)},[d,w,M]);return a.jsxs("div",{children:[a.jsx(P,{title:e("admin_panel_title"),extra:a.jsx(l,{type:"primary",onClick:n,"aria-label":e("new_user"),children:e("new_user")}),style:{marginBottom:24},children:a.jsx(K,{dataSource:p,columns:v,rowKey:"id",loading:y,pagination:!1,"aria-label":e("users_table")})}),a.jsx(P,{children:a.jsx(X,{})}),a.jsx(T,{title:e(d?"edit_user_title":"new_user"),open:_,onCancel:c,footer:[a.jsx(l,{onClick:c,"aria-label":e("cancel"),children:e("cancel")},"back"),a.jsx(l,{type:"primary",loading:f||I,onClick:()=>x.submit(),"aria-label":e(d?"save":"create"),children:e(d?"save":"create")},"submit")],children:a.jsxs(i,{form:x,layout:"vertical",onFinish:F,style:{marginTop:24},children:[a.jsx(i.Item,{name:"username",label:e("username"),rules:[{required:!0,message:e("enter_username")}],children:a.jsx(u,{})}),a.jsx(i.Item,{name:"email",label:e("email"),rules:[{required:!0,type:"email",message:e("invalid_email")}],children:a.jsx(u,{})}),!d&&a.jsx(i.Item,{name:"password",label:e("password"),rules:[{required:!0,message:e("enter_password")}],children:a.jsx(u.Password,{})}),a.jsx(i.Item,{name:"role",label:e("role"),children:a.jsx(u,{placeholder:e("role_placeholder")})})]})})]})};export{oe as default};
