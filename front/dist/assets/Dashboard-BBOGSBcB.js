import{r as F,br as S,bw as G,bo as e,bD as H,bq as J,bA as W}from"./vendor-BO8aFb6R.js";import{u as Q}from"./useApiQueries-C_dxe9Bt.js";import{P as I,C as B,A as P,p as O,a as R}from"./vendor_chart-qzWWfLLT.js";import{u as U,f as V,g as X,s as Y}from"./index-ousJY6BN.js";import{C,d as N,e as k,T as Z,f as M,g as A,h as D,E as z,B as ee}from"./vendor_antd-DBq17MzT.js";import{a as se}from"./vendor_tanstack-Croh7sPd.js";B.register(P,O,R);const{Title:$}=Z,K=(c,u)=>{const s=c.toLowerCase();return s.includes("windows 10")&&(s.includes("корпоративная")||s.includes("enterprise")||s.includes("ltsc"))?u("windows_10_enterprise","Windows 10 Enterprise"):s.includes("hyper-v")?u("hyper_v_server","Hyper-V Server"):c},te=({totalComputers:c,lastScanTime:u,clientOsData:s,serverOsData:a,softwareData:d,statusStats:n,lowDiskSpaceCount:i,onOsClick:h,onStatusClick:p})=>{const{t:o}=S(),j=G(),{timezone:w}=U(),x={clientOs:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF"],serverOs:["#FF9F40","#FFCD56","#C9CB3F","#36A2EB"],software:["#FF5733","#33FF57","#3357FF","#FF33A1","#33FFF5"]},v=s&&Array.isArray(s)?s.reduce((r,_)=>r+_.count,0):0,t=a&&Array.isArray(a)?a.reduce((r,_)=>r+_.count,0):0,l=d&&Array.isArray(d)?d.reduce((r,_)=>r+_.count,0):0,m={labels:s&&Array.isArray(s)?s.map(r=>K(r.category,o)):[],datasets:[{data:s&&Array.isArray(s)?s.map(r=>r.count):[],backgroundColor:x.clientOs}]},g={labels:a&&Array.isArray(a)?a.map(r=>K(r.category,o)):[],datasets:[{data:a&&Array.isArray(a)?a.map(r=>r.count):[],backgroundColor:x.serverOs}]},y={labels:d&&Array.isArray(d)?d.map(r=>r.category):[],datasets:[{data:d&&Array.isArray(d)?d.map(r=>r.count):[],backgroundColor:x.software}]},f={maintainAspectRatio:!1,responsive:!0,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:r=>{const _=r.raw,b=r.datasetIndex===0?v:r.datasetIndex===1?t:l,L=b?(_/b*100).toFixed(1):"0";return`${r.label}: ${_} ${o("os_tooltip_computers","Computers")} (${L} ${o("os_tooltip_percentage","Percentage")})`}}}}},E=(r,_,b)=>{if(!r.length||!_.data.labels)return;const L=r[0].index,q=_.data.labels[L];typeof q=="string"&&h(q,b)},T=[{title:o("status","Status"),dataIndex:"status",key:"status",render:r=>e.jsx("a",{onClick:()=>{p(r),j(`/computers?check_status=${encodeURIComponent(r)}`)},style:{cursor:"pointer",color:"#1890ff"},children:o(`status_${r}`,r)})},{title:o("count","Count"),dataIndex:"count",key:"count"}];return e.jsxs("div",{style:{padding:0},children:[e.jsxs(C,{style:{marginBottom:"16px"},children:[e.jsxs(N,{justify:"space-between",children:[e.jsxs(k,{children:[e.jsxs("strong",{children:[o("total_computers","Total Computers"),":"]})," ",c??"-"]}),e.jsxs(k,{children:[e.jsxs("strong",{children:[o("last_check","Last Check"),":"]})," ",u?V(u,w):o("no_data","No data")]})]}),i>0&&e.jsx(N,{style:{marginTop:8},children:e.jsx(k,{children:e.jsx(H,{to:"/?tab=low_disk_space",style:{color:"red"},children:o("low_disk_space_warning",{count:i})})})})]}),e.jsxs(N,{gutter:[16,0],children:[e.jsx(k,{span:8,children:e.jsxs(C,{children:[e.jsx($,{level:3,style:{textAlign:"center"},children:o("client_os","Client OS")}),m.labels&&m.labels.length>0?e.jsx("div",{style:{height:"260px",cursor:"pointer"},children:e.jsx(I,{data:m,options:{...f,onClick:(r,_,b)=>E(_,b,!0)}})}):e.jsx("p",{style:{textAlign:"center"},children:o("no_client_os_data","No client OS data")})]})}),e.jsx(k,{span:8,children:e.jsxs(C,{children:[e.jsx($,{level:3,style:{textAlign:"center"},children:o("server_os","Server OS")}),g.labels&&g.labels.length>0?e.jsx("div",{style:{height:"260px",cursor:"pointer"},children:e.jsx(I,{data:g,options:{...f,onClick:(r,_,b)=>E(_,b,!1)}})}):e.jsx("p",{style:{textAlign:"center"},children:o("no_server_os_data","No server OS data")})]})}),e.jsx(k,{span:8,children:e.jsxs(C,{children:[e.jsx($,{level:3,style:{textAlign:"center"},children:o("software_distribution","Software Distribution")}),y.labels&&y.labels.length>0?e.jsx("div",{style:{height:"260px",cursor:"pointer"},children:e.jsx(I,{data:y,options:{...f}})}):e.jsx("p",{style:{textAlign:"center"},children:o("no_software_data","No software data")})]})})]}),e.jsxs(C,{style:{marginTop:"16px"},children:[e.jsx($,{level:4,children:o("check_statuses","Check Statuses")}),e.jsx(M,{columns:T,dataSource:n&&Array.isArray(n)?n.filter(r=>r.count>0):[],rowKey:"status",size:"small",pagination:!1,locale:{emptyText:o("no_data","No data")}})]})]})},re=F.memo(te),ae=({lowDiskSpace:c,emptyComponent:u})=>{const{t:s}=S(),a=c.filter(n=>n.free_space_gb!==void 0&&n.free_space_gb<=1024),d=[{title:s("hostname","Hostname"),dataIndex:"hostname",key:"hostname",render:(n,i)=>e.jsx(H,{to:`/computer/${i.id}`,children:n||s("unknown","Unknown")})},{title:s("disk_id","Disk"),dataIndex:"disk_id",key:"disk_id"},{title:s("model","Model"),dataIndex:"model",key:"model",render:n=>n||s("unknown","Unknown")},{title:s("total_space","Total Space (GB)"),dataIndex:"total_space_gb",key:"total_space_gb",render:n=>n!==void 0?n.toFixed(2):s("not_available","N/A")},{title:s("free_space","Free Space (GB)"),dataIndex:"free_space_gb",key:"free_space_gb",render:n=>n!==void 0?n.toFixed(2):s("not_available","N/A")}];return!c||c.length===0?u||e.jsx("p",{style:{color:"red"},children:s("no_low_disk_data","No low disk space data")}):e.jsx("div",{style:{marginTop:"16px"},children:e.jsx(C,{children:e.jsx(N,{gutter:[16,16],children:e.jsxs(k,{span:24,children:[e.jsx("h3",{children:s("low_disk_space_computers","Computers with Low Disk Space")}),a.length>0?e.jsx(e.Fragment,{children:e.jsx(M,{columns:d,dataSource:a,rowKey:n=>`${n.id}-${n.disk_id}`,size:"middle",locale:{emptyText:u||s("no_data","No data")},pagination:!1})}):u||e.jsx("p",{children:s("no_low_disk_computers","No computers with low disk space")})]})})})})};B.register(P,O,R);const ne=({onSubnetClick:c,emptyComponent:u})=>{const{t:s}=S(),{isAuthenticated:a}=U(),[d,n]=F.useState([]),{data:i,isLoading:h,error:p,refetch:o}=se({queryKey:["computersForSubnets"],queryFn:()=>X({page:1,limit:1e3,hostname:void 0,os_name:void 0,check_status:void 0,show_disabled:!0,sort_by:"hostname",sort_order:"asc",domain:void 0}),enabled:a,refetchOnWindowFocus:!1,staleTime:3600*1e3,retry:3,retryDelay:t=>Math.min(1e3*2**t,3e4)});if(F.useEffect(()=>{if(p&&(console.error(s("error_query","Query error"),p),p instanceof J&&p.response?.data?(console.error(s("error_server_details","Server error details"),JSON.stringify(p.response.data,null,2)),A.error({message:s("error_loading_data","Error loading data"),description:s("error_loading_computers",{error:JSON.stringify(p.response.data.detail||p.message)})})):A.error({message:s("error_loading_data","Error loading data"),description:s("error_loading_computers",{error:p.message})}),o()),!!a&&i?.data&&Array.isArray(i.data)){const t=new Map;i.data.filter(m=>m.check_status!=="disabled"&&m.check_status!=="is_deleted").forEach(m=>{const g=m.ip_addresses?.[0]?.address;let y=s("unknown","Unknown");if(g){const f=g.match(/^(\d+\.\d+)\.(\d+)\.\d+$/);if(f){const E=f[1],T=parseInt(f[2]||"0",10),r=T-T%2;y=`${E}.${r}.0/23`}}t.set(y,(t.get(y)||0)+1)});const l=Array.from(t.entries()).map(([m,g])=>({subnet:m,count:g}));n(l)}},[i,p,a,o,s]),!a)return e.jsx("div",{children:s("auth_required","Authentication required")});if(h)return e.jsx("div",{children:s("loading","Loading...")});if(p)return e.jsxs("div",{style:{color:"red"},children:[s("error","Error"),": ",p.message]});if(!i||!i.data||!Array.isArray(i.data)||i.data.length===0)return u||e.jsx("div",{children:s("no_computer_data","No computer data available")});const j=d.reduce((t,l)=>t+l.count,0),w={labels:d.map(t=>t.subnet),datasets:[{label:s("computers_by_subnets","Computers by subnets"),data:d.map(t=>t.count),backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40"],borderColor:["#fff"],borderWidth:1}]},x={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},tooltip:{callbacks:{label:t=>{const l=t.raw,m=j?(l/j*100).toFixed(1):"0";return`${t.label}: ${l} ${s("os_tooltip_computers","Computers")} (${m} ${s("os_tooltip_percentage","Percentage")})`}}}},onClick:(t,l,m)=>{if(l.length&&c){const g=l[0].index,y=m.data.labels?.[g];typeof y=="string"&&c(y)}}},v=[{title:s("subnet","Subnet"),dataIndex:"subnet",key:"subnet",render:t=>e.jsx("a",{style:{cursor:"pointer",color:"#1890ff"},onClick:()=>{c&&c(t)},children:t})},{title:s("count","Count"),dataIndex:"count",key:"count"}];return e.jsxs("div",{style:{padding:12},children:[e.jsx("h2",{children:s("computers_by_subnets","Computers by subnets (/23)")}),d.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{height:300,marginBottom:24},children:e.jsx(I,{data:w,options:x})}),e.jsx(M,{columns:v,dataSource:d,rowKey:"subnet",size:"small",pagination:!1,locale:{emptyText:u||s("no_data","No data")}})]}):u||e.jsx("div",{children:s("no_subnet_data","No subnet data available")})]})},oe=({activeTab:c,onTabChange:u})=>{const{t:s}=S();return e.jsx(D,{activeKey:c,onChange:u,items:[{key:"summary",label:s("summary")},{key:"low_disk_space",label:s("low_disk_space")},{key:"subnets",label:s("subnets")}],style:{marginBottom:16}},c)};B.register(P,O,R);const _e=()=>{const{setPageTitle:c}=U(),u=W(),s=G(),{t:a}=S(),n=new URLSearchParams(u.search).get("tab")||"summary";F.useEffect(()=>{c(a("statistics","Статистика"))},[c,a]);const{data:i,error:h,isLoading:p}=Q(["total_computers","os_distribution","low_disk_space_with_volumes","last_scan_time","status_stats"]),o=t=>{const l=new URLSearchParams;t!=="Unknown"&&t!=="Other Servers"?l.set("os_name",t):t==="Other Servers"&&l.set("server_filter","server"),l.set("page","1"),l.set("limit","10"),s(`/computers?${l.toString()}`)},j=t=>{const l=new URLSearchParams;l.set("ip_range",t==="Невідомо"?"none":t),l.set("page","1"),l.set("limit","10"),s(`/computers?${l.toString()}`)},w=async()=>{try{const t=await Y("");A.success({message:a("scan_started","Сканування розпочато"),description:`Task ID: ${t.task_id}`})}catch(t){A.error({message:a("scan_error","Помилка сканування"),description:t.message})}};F.useEffect(()=>{if(h){const t=h instanceof J&&h.response?.data?JSON.stringify(h.response.data.detail||h.message):h.message;A.error({message:a("error_loading_stats","Помилка завантаження статистики"),description:t})}},[h,a]);const x=()=>e.jsx(z,{description:a("no_data","Немає даних"),image:z.PRESENTED_IMAGE_SIMPLE,children:e.jsx(ee,{type:"primary",onClick:w,children:a("start_scan","Розпочати сканування")})});if(p)return e.jsx("div",{children:a("loading","Завантаження...")});if(h)return e.jsxs("div",{style:{color:"red"},children:[a("error_loading_stats","Помилка завантаження статистики"),":"," ",h.message]});if(!i||i.total_computers===0)return x();const v=t=>{s(`?tab=${t}`,{replace:!0})};return e.jsxs("div",{style:{padding:2},children:[e.jsx(oe,{activeTab:n,onTabChange:v}),n==="summary"&&e.jsx(re,{totalComputers:i.total_computers,lastScanTime:i.scan_stats?.last_scan_time,clientOsData:i.os_stats?.client_os||[],serverOsData:i.os_stats?.server_os||[],statusStats:i.scan_stats?.status_stats||[],lowDiskSpaceCount:i.disk_stats?.low_disk_space?.length||0,onOsClick:o,onStatusClick:t=>s(`/computers?check_status=${encodeURIComponent(t)}&page=1&limit=10`)}),n==="low_disk_space"&&e.jsx(ae,{lowDiskSpace:i.disk_stats?.low_disk_space||[],emptyComponent:x()}),n==="subnets"&&e.jsx(ne,{onSubnetClick:j,emptyComponent:x()})]})};export{_e as default};
