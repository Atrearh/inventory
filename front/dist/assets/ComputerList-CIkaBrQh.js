import{r as m,br as T,bo as r,bw as R,bD as M}from"./vendor-BO8aFb6R.js";import{a as U}from"./vendor_tanstack-Croh7sPd.js";import{a as V,u as I,b as z,f as A}from"./index-ousJY6BN.js";import{g as k,I as $,i as S,j as q,B as D,k as B,f as H}from"./vendor_antd-DBq17MzT.js";import{a as Q,u as J}from"./useApiQueries-C_dxe9Bt.js";import{g as G}from"./domain.api-C7nlQmbT.js";const W=e=>({handleExportCSV:m.useCallback(async()=>{try{const c={hostname:e.hostname||void 0,os_name:e.os_name||void 0,check_status:e.check_status==="is_deleted"?void 0:e.check_status||void 0,sort_by:e.sort_by||"hostname",sort_order:e.sort_order==="asc"||e.sort_order==="desc"?e.sort_order:"asc",server_filter:e.server_filter||void 0},p=await V.get("/computers/export/csv",{params:c,responseType:"blob",paramsSerializer:v=>{const a=new URLSearchParams;for(const[d,o]of Object.entries(v))o!==void 0&&o!==""&&a.append(d,String(o));return a.toString()}}),b=`computers_${new Date().toISOString().split("T")[0]}.csv`,_=window.URL.createObjectURL(new Blob([p.data])),n=document.createElement("a");n.href=_,n.setAttribute("download",b),document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(_),k.success({message:"Успех",description:"Файл CSV успешно скачан"})}catch(c){k.error({message:"Ошибка",description:`Не удалось экспортировать данные в CSV: ${c.response?.data?.detail||c.message}`})}},[e])}),X="_container_dp692_1",Y="_title_dp692_9",Z="_filters_dp692_27",ee="_filterInput_dp692_39",se="_filterSelect_dp692_47",te="_link_dp692_63",u={container:X,title:Y,filters:Z,filterInput:ee,filterSelect:se,link:te},ae=[{labelKey:"all_statuses",value:"",defaultLabel:"Усі статуси"},{labelKey:"status_success",value:"success",defaultLabel:"Успішно"},{labelKey:"status_failed",value:"failed",defaultLabel:"Невдало"},{labelKey:"status_unreachable",value:"unreachable",defaultLabel:"Недоступно"},{labelKey:"status_partially_successful",value:"partially_successful",defaultLabel:"Частково успішно"},{labelKey:"status_disabled",value:"disabled",defaultLabel:"Відключено"},{labelKey:"status_is_deleted",value:"is_deleted",defaultLabel:"Видалено"}],re=({filters:e,statsData:f,isStatsLoading:c,domainsData:p,isDomainsLoading:y,debouncedSetHostname:b,debouncedSetOsName:_,debouncedSetDomain:n,debouncedSetCheckStatus:v,handleFilterChange:a,clearAllFilters:d})=>{const{t:o}=T(),h=m.useRef(null),g=f?.os_stats?.client_os?.map(s=>({label:s.category,value:s.category}))||[],C=p?.map(s=>({label:s.name,value:s.name}))||[];return r.jsxs("div",{className:u.filters,children:[r.jsx($,{ref:h,placeholder:o("enter_hostname","Фільтр за ім’ям хоста (пошук за початком)"),value:e.hostname,onChange:s=>b(s.target.value),className:u.filterInput,allowClear:!0}),r.jsx(S,{value:e.os_name||void 0,onChange:s=>_(s),className:u.filterSelect,placeholder:o("select_os","Оберіть ОС"),loading:c,showSearch:!0,optionFilterProp:"children",options:[{label:o("all_os","Усі ОС"),value:""},...g],allowClear:!0}),r.jsx(S,{value:e.check_status||void 0,onChange:s=>v(s),className:u.filterSelect,placeholder:o("select_status","Усі статуси"),options:ae.map(s=>({label:o(s.labelKey,s.defaultLabel),value:s.value})),allowClear:!0}),r.jsx(S,{value:e.domain||void 0,onChange:s=>n(s),className:u.filterSelect,placeholder:o("select_domain","Оберіть домен"),showSearch:!0,optionFilterProp:"children",options:[{label:o("all_domains","Усі домени"),value:""},...C],loading:y,allowClear:!0}),r.jsx(q,{checked:e.show_disabled,onChange:s=>a("show_disabled",s.target.checked),style:{marginLeft:8},children:o("show_disabled","Показувати відключені та видалені")}),r.jsx(D,{onClick:d,style:{marginLeft:8},children:o("clear_filters","Очистити всі фільтри")})]})},ue=()=>{const{t:e}=T(),f=R(),{timezone:c}=I(),{setPageTitle:p}=I(),[y,b]=m.useState([]),{data:_,isLoading:n}=U({queryKey:["domains"],queryFn:G}),v=m.useMemo(()=>{const t=new Map;return _?.forEach(l=>{t.set(l.id,l.name)}),t},[_]),{filters:a,filteredComputers:d,debouncedSetHostname:o,handleFilterChange:h,clearAllFilters:g,handleTableChange:C}=z(y,v),{data:s,error:w,isLoading:E}=Q({...a,hostname:void 0,os_name:void 0,check_status:void 0,sort_by:void 0,sort_order:void 0,limit:1e3}),{data:O,error:x,isLoading:L}=J(["os_distribution"]),{handleExportCSV:N}=W(a);m.useEffect(()=>{if(s?.data){const l=Array.from(new Map(s.data.map(i=>[i.id,i])).values()).slice(0,1e3).map(i=>({...i,last_updated:i.last_updated||"",last_check:i.last_full_scan||""}));b(l),p(`${e("computers_list","Список комп’ютерів")} (${d.total||0})`),s.total>1e3&&k.warning({message:e("data_limit","Обмеження даних"),description:e("data_limit_description","Відображається лише перші 1000 комп’ютерів. Використовуйте фільтри для точного пошуку.")})}},[s,e,d.total,p]);const K=t=>{switch(t){case"success":return"#52c41a";case"failed":case"unreachable":return"#ff4d4f";case"partially_successful":return"#faad14";case"disabled":case"is_deleted":return"#8c8c8c";default:return"#000"}},F=t=>{if(!t)return"#000";const l=new Date(t),j=(new Date().getTime()-l.getTime())/(1e3*3600*24);return j<=7?"#52c41a":j<=14?"#faad14":"#ff4d4f"},P=m.useMemo(()=>[{title:e("hostname","Ім’я хоста"),dataIndex:"hostname",key:"hostname",sorter:!0,sortOrder:a.sort_by==="hostname"?a.sort_order==="asc"?"ascend":"descend":void 0,render:(t,l)=>r.jsx(M,{to:`/computer/${l.id}`,className:u.link,children:l.hostname})},{title:e("ip_addresses","IP-адреси"),dataIndex:"ip_addresses",key:"ip_addresses",sorter:!1,render:(t,l)=>l.ip_addresses?.map(i=>i.address).join(", ")||"-"},{title:e("os_name","Операційна система"),dataIndex:"os",key:"os",sorter:!0,sortOrder:a.sort_by==="os"?a.sort_order==="asc"?"ascend":"descend":void 0,render:t=>t?.name??"-"},{title:e("last_check","Остання перевірка"),dataIndex:"last_full_scan",key:"last_full_scan",sorter:!0,sortOrder:a.sort_by==="last_full_scan"?a.sort_order==="asc"?"ascend":"descend":void 0,render:t=>r.jsx("span",{style:{color:F(t)},children:t?A(t,c):"-"})},{title:e("check_status","Статус перевірки"),dataIndex:"check_status",key:"check_status",sorter:!0,sortOrder:a.sort_by==="check_status"?a.sort_order==="asc"?"ascend":"descend":void 0,render:t=>{const l={success:e("status_success","Успішно"),failed:e("status_failed","Невдало"),unreachable:e("status_unreachable","Недоступно"),partially_successful:e("status_partially_successful","Частково успішно"),disabled:e("status_disabled","Відключено"),is_deleted:e("status_is_deleted","Видалено")};return r.jsx("span",{style:{color:K(t)},children:l[t||""]||t||"-"})}}],[e,a.sort_by,a.sort_order,c]);return m.useEffect(()=>{const t=w||x;t&&t.response?.status===401&&f("/login")},[w,x,f]),r.jsx("div",{className:u.container,children:E||L||n?r.jsx(B,{active:!0,paragraph:{rows:10}}):r.jsxs(r.Fragment,{children:[r.jsxs("h2",{className:u.title,children:[e("computers_list","Список комп’ютерів")," (",d.total||0,")",r.jsx(D,{type:"primary",onClick:N,className:u.csvButton,children:e("export_csv","Експорт у CSV")})]}),r.jsx(re,{filters:a,statsData:O,isStatsLoading:L,domainsData:_,isDomainsLoading:n,debouncedSetHostname:o,debouncedSetOsName:h.bind(null,"os_name"),debouncedSetDomain:h.bind(null,"domain"),debouncedSetCheckStatus:h.bind(null,"check_status"),handleFilterChange:h,clearAllFilters:g}),r.jsx(H,{columns:P,dataSource:d.data,rowKey:"id",pagination:{current:a.page,pageSize:a.limit,total:d.total||0,showSizeChanger:!1,showQuickJumper:!1},onChange:C,locale:{emptyText:e("no_data","Немає даних для відображення")},size:"small",showSorterTooltip:!1})]})})};export{ue as default};
